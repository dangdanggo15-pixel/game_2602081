<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Magic Stacker: Pixel Final</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body { 
            margin: 0; overflow: hidden; background: #1a1a2e; 
            font-family: 'Press Start 2P', cursive; 
        }

        /* 배경 이미지 레이어: z-index를 -2로 설정하여 가장 뒤로 보냄 */
        #bg-image {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('background.png') no-repeat center center;
            background-size: cover;
            z-index: -2;
        }

        /* 화면을 더 깊이감 있게 만드는 오버레이 */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 40%, rgba(0,0,0,0.7) 100%);
            pointer-events: none; z-index: -1;
        }

        #ui { 
            position: absolute; top: 40px; width: 100%; text-align: center; 
            color: #fff; pointer-events: none; z-index: 10; 
        }

        .logo {
            font-size: 28px; color: #ffd700;
            text-shadow: 4px 4px #8b4513, 0 0 15px rgba(255, 215, 0, 0.6);
            margin-bottom: 15px;
        }

        .score-box {
            background: rgba(44, 30, 18, 0.8);
            padding: 10px 25px; border: 3px solid #ffd700;
            display: inline-block; box-shadow: 0 4px 0 #8b4513;
        }

        #msg { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; display: none; z-index: 100;
            background: rgba(60, 30, 10, 0.95); padding: 50px; 
            border: 6px double #ffd700; box-shadow: 0 0 50px #000;
        }

        button { 
            margin-top: 20px; padding: 15px 35px; background: #ffd700; 
            color: #4a2511; border: none; cursor: pointer; 
            font-family: inherit; font-size: 18px; font-weight: bold;
            box-shadow: 0 6px #b8860b;
        }
        button:hover { background: #ffea00; }
        button:active { transform: translateY(3px); box-shadow: 0 3px #b8860b; }
    </style>
</head>
<body>

<div id="bg-image"></div>
<div class="overlay"></div>

<div id="ui">
    <div class="logo">MAGIC STACKER</div>
    <div class="score-box">SCORE: <span id="scoreText">00</span></div>
</div>

<div id="msg">
    <h2 style="color: #ff4d4d; margin-top: 0;">STACK OVERLOAD!</h2>
    <p>최종 점수: <span id="finalScore">0</span></p>
    <button onclick="location.reload()">RE-CASTING</button>
</div>

<script>
/**
 * 검토 결과: Render 옵션에서 pixelated 처리를 추가하고 
 * 배경 투명도 설정을 강화하여 background.png가 잘 보이게 수정함.
 */
const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
const engine = Engine.create();
const world = engine.world;

const render = Render.create({
    element: document.body,
    engine: engine,
    options: {
        width: window.innerWidth,
        height: window.innerHeight,
        wireframes: false,
        background: 'transparent' // 캔버스를 투명하게 하여 배경 이미지가 투사되게 함
    }
});

Render.run(render);
const runner = Runner.create();
Runner.run(runner, engine);

// 도트풍 게임을 위해 캔버스 앨리어싱 방지 (더 선명하게)
render.canvas.style.imageRendering = 'pixelated';

// 바닥 생성 (ground.png)
const ground = Bodies.rectangle(window.innerWidth/2, window.innerHeight - 80, 500, 80, { 
    isStatic: true, 
    render: { 
        sprite: { texture: 'ground.png' } 
    } 
});
Composite.add(world, ground);

let score = 0;
let isGameOver = false;

// 효과음 생성기
function playSound(f) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.value = f; osc.type = 'square'; // 도트 감성 사각파
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
    osc.stop(ctx.currentTime + 0.1);
}

window.addEventListener('mousedown', (e) => {
    if (isGameOver) return;

    const id = Math.floor(Math.random() * 5) + 1;
    const size = 60 + Math.random() * 40;

    const item = Bodies.rectangle(e.clientX, 100, size, size, {
        restitution: 0.1, friction: 0.8,
        render: {
            sprite: { 
                texture: `item${id}.png`,
                xScale: size / 100,
                yScale: size / 100
            }
        }
    });

    Composite.add(world, item);
    playSound(400 + (score * 50));
    score++;
    document.getElementById('scoreText').innerText = score.toString().padStart(2, '0');
});

Events.on(engine, 'afterUpdate', () => {
    Composite.allBodies(world).forEach(b => {
        if (!b.isStatic && b.position.y > window.innerHeight + 100) {
            if (!isGameOver) {
                isGameOver = true;
                document.getElementById('finalScore').innerText = score;
                document.getElementById('msg').style.display = 'block';
                playSound(150);
            }
        }
    });
});

window.addEventListener('resize', () => {
    render.canvas.width = window.innerWidth;
    render.canvas.height = window.innerHeight;
});
</script>
</body>
</html>
