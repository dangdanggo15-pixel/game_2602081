<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Magic Stacker: Pixel Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: 'Press Start 2P', cursive; /* 픽셀 전용 폰트 */
        }
        
        /* 배경 레이어 (bg.png 대신 background.png 사용 시 여기서 수정) */
        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('background.png') no-repeat center center;
            background-size: cover;
            z-index: -1;
            filter: brightness(0.6) contrast(1.2); /* 배경을 살짝 어둡게 해서 UI 강조 */
        }

        /* 비네팅 효과 (가장자리를 어둡게 해서 분위기 조성) */
        .vignette {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.8);
            pointer-events: none; z-index: 1;
        }

        #ui { 
            position: absolute; top: 40px; width: 100%; text-align: center; 
            color: #fff; pointer-events: none; z-index: 10; 
        }

        /* 세련된 타이틀 로고 */
        .logo {
            font-size: 32px;
            color: #ffd700;
            text-shadow: 4px 4px #8b4513, 0 0 20px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
            letter-spacing: -2px;
        }

        .score-board {
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 10px;
            display: inline-block;
            border: 2px solid #ffd700;
        }

        #msg { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; display: none; z-index: 100;
            background: rgba(139, 69, 19, 0.9); padding: 40px; border: 4px solid #ffd700;
        }

        button { 
            padding: 15px 30px; background: #ffd700; color: #8b4513; 
            border: none; cursor: pointer; font-family: inherit; font-size: 16px;
            box-shadow: 0 5px #b8860b; transition: 0.1s;
        }
        button:active { transform: translateY(5px); box-shadow: 0 0px #b8860b; }
    </style>
</head>
<body>

<div id="bg-layer"></div>
<div class="vignette"></div>

<div id="ui">
    <div class="logo">MAGIC STACKER</div>
    <div class="score-board">SCORE: <span id="scoreText">0</span></div>
</div>

<div id="msg">
    <h2 style="font-size: 24px;">CASTING FAILED!</h2>
    <p>쌓은 재료 수: <span id="finalScore">0</span></p>
    <button onclick="location.reload()">RETRY</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
const engine = Engine.create();
const world = engine.world;

const render = Render.create({
    element: document.body,
    canvas: document.getElementById('gameCanvas'),
    engine: engine,
    options: {
        width: window.innerWidth,
        height: window.innerHeight,
        wireframes: false,
        background: 'transparent'
    }
});

Render.run(render);
const runner = Runner.create();
Runner.run(runner, engine);

// 바닥 설정 (ground.png 사용)
const ground = Bodies.rectangle(window.innerWidth/2, window.innerHeight - 80, 500, 80, { 
    isStatic: true, 
    render: { sprite: { texture: 'ground.png' } } 
});
Composite.add(world, ground);

let score = 0;
let isGameOver = false;

function playBeep(freq) {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.frequency.value = freq;
    oscillator.start();
    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
    oscillator.stop(audioCtx.currentTime + 0.1);
}

window.addEventListener('mousedown', (e) => {
    if (isGameOver) return;

    const itemNum = Math.floor(Math.random() * 5) + 1;
    const itemSize = 70 + Math.random() * 30;

    const item = Bodies.rectangle(e.clientX, 100, itemSize, itemSize, {
        restitution: 0.2,
        friction: 0.6,
        render: {
            sprite: { 
                texture: `item${itemNum}.png`,
                xScale: itemSize / 100,
                yScale: itemSize / 100
            }
        }
    });

    Composite.add(world, item);
    playBeep(300 + (score * 30));
    score++;
    document.getElementById('scoreText').innerText = score;
});

Events.on(engine, 'afterUpdate', () => {
    Composite.allBodies(world).forEach(body => {
        if (!body.isStatic && body.position.y > window.innerHeight) {
            if (!isGameOver) {
                isGameOver = true;
                document.getElementById('finalScore').innerText = score;
                document.getElementById('msg').style.display = 'block';
                playBeep(150);
            }
        }
    });
});

window.addEventListener('resize', () => {
    render.canvas.width = window.innerWidth;
    render.canvas.height = window.innerHeight;
});
</script>
</body>
</html>
